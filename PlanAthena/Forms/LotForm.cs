// Fichier: PlanAthena/Forms/LotForm.cs
// Version: 0.4.4
// Description: Corrig√© pour utiliser le ProjetService "stateful" refondu.

using PlanAthena.Data;
using PlanAthena.Services.Business;
using System;
using System.Data;
using System.Linq;
using System.Windows.Forms;

namespace PlanAthena.Forms
{
    public partial class LotForm : Form
    {
        private readonly ProjetService _projetService;
        private Lot _lotSelectionne = null;
        private bool _isEditing = false;
        private readonly ToolTip _toolTip = new ToolTip();

        // CORRIG√â : Le constructeur est simplifi√©.
        public LotForm(ProjetService projetService)
        {
            InitializeComponent();
            _projetService = projetService ?? throw new ArgumentNullException(nameof(projetService));
        }

        private void LotForm_Load(object sender, EventArgs e)
        {
            InitialiserComboBoxPhases();
            SetEditingMode(false);
            RafraichirAffichageComplet();
        }

        private void InitialiserComboBoxPhases()
        {
            var phasesValides = Enum.GetValues(typeof(ChantierPhase))
                                    .Cast<ChantierPhase>()
                                    .Where(p => p != ChantierPhase.None)
                                    .ToList();
            cmbPhases.DataSource = phasesValides;
            cmbPhases.SelectedItem = null;
        }

        private void SetEditingMode(bool isEditing)
        {
            _isEditing = isEditing;
            listViewLots.Enabled = !isEditing;
            groupBoxDetails.Enabled = isEditing;

            txtNom.ReadOnly = !isEditing;
            numPriorite.ReadOnly = !isEditing;
            btnParcourirPlan.Enabled = isEditing;
            cmbPhases.Enabled = isEditing;
            txtLotId.ReadOnly = true;

            btnNouveau.Visible = !isEditing;
            btnSupprimer.Visible = !isEditing;
            btnModifier.Text = isEditing ? "üíæ Sauvegarder" : "‚úèÔ∏è Modifier";
            btnModifier.Enabled = isEditing || _lotSelectionne != null;
            btnAnnuler.Visible = isEditing;

            bool lotPeutEtreSupprime = _lotSelectionne != null && !IsLotInUse(_lotSelectionne.LotId);
            btnSupprimer.Enabled = lotPeutEtreSupprime;
            _toolTip.SetToolTip(btnSupprimer, lotPeutEtreSupprime
                ? "Supprimer le lot s√©lectionn√©."
                : "Ce lot ne peut pas √™tre supprim√© car il est utilis√© par au moins une t√¢che.");
        }

        // CORRIG√â : L'appel √† _tacheService est remplac√© par _projetService
        private bool IsLotInUse(string lotId)
        {
            if (string.IsNullOrEmpty(lotId)) return false;
            return _projetService.ObtenirTachesParLot(lotId).Any();
        }

        #region Gestion des donn√©es et affichage

        private void RafraichirAffichageComplet()
        {
            var idLotSelectionne = _lotSelectionne?.LotId;
            RafraichirListeLots();

            if (idLotSelectionne != null)
            {
                var itemToReselect = listViewLots.Items.Cast<ListViewItem>()
                    .FirstOrDefault(item => (item.Tag as Lot)?.LotId == idLotSelectionne);
                if (itemToReselect != null)
                {
                    itemToReselect.Selected = true;
                }
            }
            else
            {
                _lotSelectionne = null;
                NettoyerDetails();
            }
            RafraichirStatut();
            SetEditingMode(_isEditing); // Appel√© apr√®s avoir potentiellement re-s√©lectionn√©
        }

        private void RafraichirListeLots()
        {
            listViewLots.Items.Clear();
            var lots = _projetService.ObtenirTousLesLots();
            foreach (var lot in lots)
            {
                var item = new ListViewItem(new[] { lot.LotId, lot.Nom, lot.Priorite.ToString() }) { Tag = lot };
                listViewLots.Items.Add(item);
            }
        }

        private void RafraichirStatut()
        {
            lblStatut.Text = $"{listViewLots.Items.Count} lot(s)";
        }

        private void AfficherDetailsLot(Lot lot)
        {
            _lotSelectionne = lot;
            if (lot == null)
            {
                NettoyerDetails();
                return;
            }
            txtLotId.Text = lot.LotId;
            txtNom.Text = lot.Nom;
            numPriorite.Value = lot.Priorite > 0 ? lot.Priorite : 1;
            txtCheminFichierPlan.Text = lot.CheminFichierPlan;
            groupBoxDetails.Text = $"D√©tails: {lot.Nom}";

            var optionsValides = cmbPhases.DataSource as List<ChantierPhase>;
            if (optionsValides != null && optionsValides.Contains(lot.Phases))
            {
                cmbPhases.SelectedItem = lot.Phases;
            }
            else
            {
                cmbPhases.SelectedItem = null;
            }
        }

        private void NettoyerDetails()
        {
            txtLotId.Clear();
            txtNom.Clear();
            numPriorite.Value = 1;
            txtCheminFichierPlan.Clear();
            groupBoxDetails.Text = "D√©tails du Lot";
        }

        #endregion

        #region √âv√©nements interface

        private void listViewLots_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (_isEditing) return;
            if (listViewLots.SelectedItems.Count > 0)
            {
                _lotSelectionne = listViewLots.SelectedItems[0].Tag as Lot;
                AfficherDetailsLot(_lotSelectionne);
            }
            else
            {
                _lotSelectionne = null;
                NettoyerDetails();
            }
            SetEditingMode(false);
        }

        private void btnFermer_Click(object sender, EventArgs e) => this.Close();

        private void btnParcourirPlan_Click(object sender, EventArgs e)
        {
            using var ofd = new OpenFileDialog { /* ... */ };
            if (ofd.ShowDialog() == DialogResult.OK)
            {
                txtCheminFichierPlan.Text = ofd.FileName;
            }
        }

        #endregion

        #region Actions CRUD

        private void btnNouveau_Click(object sender, EventArgs e)
        {
            listViewLots.SelectedItems.Clear();
            // CORRIG√â : Utilise maintenant la m√©thode Creer de ProjetService
            _lotSelectionne = _projetService.CreerLot();
            AfficherDetailsLot(_lotSelectionne);
            SetEditingMode(true);
            txtNom.Focus();
            txtNom.SelectAll();
        }

        private void btnModifier_Click(object sender, EventArgs e)
        {
            if (!_isEditing)
            {
                if (_lotSelectionne == null) return;
                SetEditingMode(true);
                txtNom.Focus();
                txtNom.SelectAll();
                return;
            }

            try
            {
                if (cmbPhases.SelectedItem is not ChantierPhase phaseSelectionnee)
                {
                    MessageBox.Show("Veuillez s√©lectionner une phase pour le lot.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }
                if (string.IsNullOrWhiteSpace(txtNom.Text))
                {
                    MessageBox.Show("Le nom du lot ne peut pas √™tre vide.", "Validation", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                _lotSelectionne.Nom = txtNom.Text;
                _lotSelectionne.Priorite = (int)numPriorite.Value;
                _lotSelectionne.CheminFichierPlan = txtCheminFichierPlan.Text;
                _lotSelectionne.Phases = phaseSelectionnee;

                _projetService.ModifierLot(_lotSelectionne);

                SetEditingMode(false);
                RafraichirAffichageComplet();
            }
            catch (Exception ex)
            {
                MessageBox.Show(ex.Message, "Erreur de sauvegarde", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btnAnnuler_Click(object sender, EventArgs e)
        {
            SetEditingMode(false);
            if (listViewLots.SelectedItems.Count > 0)
            {
                _lotSelectionne = listViewLots.SelectedItems[0].Tag as Lot;
                AfficherDetailsLot(_lotSelectionne);
            }
            else
            {
                _lotSelectionne = null;
                NettoyerDetails();
            }
        }

        private void btnSupprimer_Click(object sender, EventArgs e)
        {
            if (_lotSelectionne == null) return;
            var result = MessageBox.Show($"√ätes-vous s√ªr de vouloir supprimer le lot '{_lotSelectionne.Nom}' ?", "Confirmation", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
            if (result == DialogResult.Yes)
            {
                try
                {
                    _projetService.SupprimerLot(_lotSelectionne.LotId);
                    _lotSelectionne = null;
                    NettoyerDetails();
                    SetEditingMode(false);
                    RafraichirAffichageComplet();
                }
                catch (Exception ex)
                {
                    MessageBox.Show(ex.Message, "Erreur de suppression", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        #endregion
    }
}