@startuml
skinparam sequenceArrowColor #005588
skinparam sequenceLifeLineBorderColor #007ACC
skinparam sequenceParticipantBackgroundColor #DDEEFF

title Service de Suggestions - Flux Principal (Version "Graph First" + Exclusions)

participant UI as "TacheDetailForm"
participant DB as "DependanceBuilder"
participant MS as "MetierService"
participant TS as "TacheService"

Note over UI,TS: Cas d'Usage: CrÃ©ation/Modification de TÃ¢che

UI->>UI: Utilisateur ouvre formulaire tÃ¢che
UI->>DB: ObtenirDependancesPourTache(tache, contexteTaches)
activate DB

Note over DB: Phase 1: Construction Graphe + Anti-Cycles
DB->>DB: ConstruireGrapheBloc(contexteTaches)
Note over DB: Source de vÃ©ritÃ© : dÃ©pendances rÃ©elles
DB->>DB: CalculerTousLesSuccesseurs(graphe, contexteTaches)
Note over DB: Parcours en profondeur pour chaque tÃ¢che
DB->>DB: FiltrerCandidatsValides(tache, contexteTaches, successeurs)
Note over DB: RÃ¨gle anti-cycle : exclure successeurs de la tÃ¢che
DB->>DB: â†’ candidatsValides (mÃªme bloc, anti-cycles garantis)

Note over DB: Phase 2: Identification Suggestions + Gestion Exclusions
DB->>DB: AppliquerSuggestionsMetier(tache, candidatsValides)
alt TÃ¢che a un mÃ©tier
    DB->>MS: GetPrerequisForMetier(tache.MetierId)
    MS-->>DB: PrÃ©requis directs
    DB->>DB: ParseDependances(tache.ExclusionsDependances)
    Note over DB: Obtenir exclusions utilisateur
    DB->>DB: Identifier mÃ©tiers prÃ©sents dans bloc
    
    alt PrÃ©requis directs prÃ©sents
        DB->>DB: Utiliser prÃ©requis directs
    else Aucun prÃ©requis direct
        Note over DB: RemontÃ©e de chaÃ®ne
        DB->>DB: RemonterChainePrerequis(metierId, metiersPresents)
    end
    
    loop Pour chaque mÃ©tier prÃ©requis
        DB->>DB: Filtrer tÃ¢ches exclues du mÃ©tier prÃ©requis
        Note over DB: Cas Particulier 2 : Si fin de chaÃ®ne exclue â†’ remonter
        DB->>DB: TrouverMeilleuresTachesPourSuggestion(tachesNonExclues, candidatsValides)
        Note over DB: Jalons > Fins de chaÃ®ne > Toutes tÃ¢ches mÃ©tier
        DB->>DB: Ajouter suggestions (si tÃ¢ches non exclues)
    end
end

Note over DB: Phase 3: Classification
DB->>DB: ParseDependances(tache.Dependencies)
DB->>DB: ParseDependances(tache.ExclusionsDependances)
DB->>DB: ClassifierDependances(candidatsValides, strictes, excluses, suggestions)

loop Pour chaque candidat valide
    alt Dans Dependencies
        DB->>DB: CrÃ©er DependanceAffichage(Etat.Stricte, EstHeritee=false)
    else Dans ExclusionsDependances
        DB->>DB: CrÃ©er DependanceAffichage(Etat.Exclue, EstHeritee=true)
    else Dans suggestions
        DB->>DB: CrÃ©er DependanceAffichage(Etat.Suggeree, EstHeritee=true)
    else
        DB->>DB: CrÃ©er DependanceAffichage(Etat.Neutre, EstHeritee=false)
    end
end

DB->>DB: Trier par TacheNom
DB-->>UI: List<DependanceAffichage>
deactivate DB

Note over UI: Affichage avec Ã‰tats Visuels + IcÃ´nes
UI->>UI: Afficher liste avec icÃ´nes/coches
Note over UI: Stricte: âœ… + cochÃ©
Note over UI: Exclue: âŒ + dÃ©cochÃ©  
Note over UI: SuggÃ©rÃ©e: ðŸ’¡ + cochÃ©
Note over UI: Neutre: âšª + dÃ©cochÃ©

Note over UI: Infobulles sur survol
UI->>UI: MouseMove â†’ Afficher ID, mÃ©tier, durÃ©e, Ã©tat

Note over UI,TS: Sauvegarde des Modifications
User->>UI: Modifie coches et sauvegarde
UI->>UI: SauvegarderModifications()
Note over UI: CochÃ© â†’ Dependencies
Note over UI: DÃ©cochÃ© (si suggÃ©rÃ©e) â†’ ExclusionsDependances
UI->>TS: ModifierTache(tache)
activate TS
TS->>TS: Persister Dependencies et ExclusionsDependances
deactivate TS

@enduml