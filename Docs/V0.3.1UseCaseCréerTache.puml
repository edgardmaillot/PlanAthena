@startuml
' --- Configuration ---
skinparam componentStyle uml2
skinparam wrapWidth 200
skinparam participantPadding 5
skinparam sequenceMessageAlign center
skinparam sequenceArrowColor #005588
skinparam sequenceLifeLineBorderColor #007ACC
skinparam sequenceParticipantBackgroundColor #DDEEFF

title Séquence de cas d'usage 1 : Création d'une nouvelle tâche

actor User
participant TacheForm
participant "TacheDetailForm\n(en Popup)" as Popup
participant DependanceBuilder
participant TacheService

group Initialisation de la popup
    User -> TacheForm : Clique sur un bouton Métier
    activate TacheForm

    TacheForm -> Popup ** : new TacheDetailForm(...)
    TacheForm -> Popup : Crée un objet `Tache` pré-rempli\n(avec LotId, MetierId)
    TacheForm -> Popup : ChargerTache(tache, modeCreation=true)
    TacheForm -> Popup : ShowDialog()
    activate Popup
    deactivate TacheForm
end

group Affichage des dépendances
    Popup -> DependanceBuilder : ObtenirEtatDependancesPourTache(tache, toutesLesTaches)
    activate DependanceBuilder
    
    note right: **Règle stricte de filtrage**
    Builder -> Builder : Filtre les tâches candidates pour ne garder\nque celles du **même bloc** que la tâche en cours.
    Builder -> Builder : Filtre à nouveau pour exclure les métiers "descendants".
    
    Builder --> Popup : retourne [ListeDependancePourUI] (filtrée)
    deactivate DependanceBuilder
    
    Popup -> Popup : Affiche la liste des dépendances possibles
end

group Sauvegarde
    User -> Popup : Remplit les détails et coche une dépendance (ex: T001)
    User -> Popup : Clique sur "Sauvegarder"
    
    Popup -> Popup : **SauvegarderModifications()**
    Popup -> TacheService : **AjouterTache(_tache)**
    activate TacheService
    deactivate TacheService
    
    Popup -> DependanceBuilder : **ConstruireDependancesLogiques(toutesLesTaches)**
    activate DependanceBuilder
    deactivate DependanceBuilder

    Popup -> Popup : met DialogResult = OK et se ferme
end

group Rafraîchissement
    Popup --> TacheForm : retourne DialogResult.OK
    deactivate Popup
    activate TacheForm

    TacheForm -> TacheForm : **RafraichirDiagrammeEtStatistiques()**
    deactivate TacheForm
end
@enduml