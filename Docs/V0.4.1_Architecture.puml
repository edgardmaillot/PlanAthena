@startuml
title Architecture PlanAthena - Export Excel + Chemins Pr√©f√©r√©s (v0.4.1)

!define DIRECTION top to bottom direction
top to bottom direction
skinparam packageStyle rectangle
skinparam linetype ortho

skinparam package {
  borderColor #555555
  borderThickness 2
  fontColor #333333
  backgroundColor #F8F9FA
}

skinparam class {
  borderColor #007ACC
  backgroundColor #DDEEFF
  arrowColor #005588
}

' ================================================
' === COUCHE IHM ===
' ================================================
package "üñ•Ô∏è Interface Utilisateur" as UI {
  
  package "Gestion de Projet" {
    class MainForm {
      == Export Planning v0.4.1 ==
      +btnExportPlanningExcel_Click()
      +VerifierDisponibiliteExportExcel()
      
      == Chemins Pr√©f√©r√©s v0.4.1 ==
      Uses CheminsPrefereService
      for all file dialogs
    }
    class NouveauProjetDialog
  }
  
  package "Qualification des T√¢ches" {
    class TacheForm
    class TacheDetailForm
    class ImportTacheForm
    class ImportCsvGroupeDialog
    class ImportWarningsDialog
  }
  
  package "Configuration Ressources" {
    class OuvrierForm
    class MetierForm
    class LotForm
    class BlocForm
    class CompetenceDialog
    class SelectionMetierDialog
  }
  
  package "Visualisation" {
    class PertDiagramControl
    class MetierDiagramControl
  }
}

' ================================================
' === COUCHE M√âTIER ===
' ================================================
package "‚öôÔ∏è Services M√©tier" as BUSINESS {
  
  class ProjetService {
    == Gestion Projet ==
    +CreerNouveauProjet()
    +SauvegarderProjet()
    +ChargerProjet()
    +ObtenirResumeProjet()
    +ValiderDonneesAvantPlanification()
    
    == Gestion M√©tiers ==
    +AjouterMetier()
    +ModifierMetier()
    +SupprimerMetier()
    +GetAllMetiers()
    +ObtenirMetiersTriesParDependance()
    
    == Gestion Lots (Fusionn√© v0.3.9) ==
    +AjouterLot()
    +ModifierLot()
    +ObtenirLotParId()
    +ObtenirTousLesLots()
    +SupprimerLot()
    +RemplacerTousLesLots()
    +ViderLots()
  }
  
  class TacheService {
    == Qualification T√¢ches ==
    +AjouterTache()
    +ModifierTache()
    +SupprimerTache()
    +ObtenirTachesParLot()
    +ObtenirStatistiques()
    
    == Gestion Blocs (Contraintes) ==
    +AjouterBloc()
    +ModifierBloc()
    +ObtenirTousLesBlocs()
    +SupprimerBloc()
    +ValiderDependancesIntraBloc()
    +CalculerCapaciteOuvriers()
    
    == Import/Export ==
    +ImporterTachesCSV()
    +ExporterTaches()
    
    --Dependencies--
    -_projetServiceFactory: Func<ProjetService>
  }
  
  class OuvrierService {
    == Gestion Ressources ==
    +AjouterOuvrier()
    +ModifierOuvrier()
    +SupprimerOuvrier()
    +ObtenirTousLesOuvriers()
    +GererCompetences()
  }
  
  class BlocService {
    == Gestion Contraintes ==
    +AjouterBloc()
    +ModifierBloc()
    +SupprimerBloc()
    +ObtenirTousLesBlocs()
    +ValiderDependancesIntraBloc()
    
    --Dependencies--
    -_tacheServiceFactory: Func<TacheService>
  }
  
  class PlanificationService {
    == Planification Optimale ==
    +LancerPlanificationAsync()
    +ObtenirStatistiquesTraitement()
    +ChargerDonnees()
    
    == Pr√©paration Solveur ==
    +PreparerPourSolveur()
    +TransformToChantierSetupDto()
    
    == Consolidation R√©sultats ==
    +ConsoliderPourGantt()
    +ExporterVersGantt()
  }
  
  class ImportOrchestrationService {
    == Import Orchestr√© ==
    +ImporterTachesDepuisCsv()
    +ValiderStructureFichier()
    +GererMappingConfiguration()
    
    --Dependencies--
    -_projetService: ProjetService
  }
}

' ================================================
' === üÜï COUCHE EXPORT (v0.4.1) ===
' ================================================
package "üìä Services Export" as EXPORT {
  
  class PlanningExcelExportService {
    == Export Multi-Onglets ==
    +ExporterPlanningComplet()
    
    == Consolidation Donn√©es ==
    -ConsoliderDonnees()
    -ConsoliderPlanningsOuvriers()
    -ConsoliderStatistiquesMetiers()
    
    == Templates Excel ==
    -CreerOngletSynthese()
    -CreerOngletOuvrier()
    -FormatAsHeader()
    
    == Calculs KPI ==
    -CalculerJoursOuvres()
    -GenererCreneauxComplets()
    
    == Multi-t√¢ches Support ==
    Supports multiple tasks per day
    Handles ouvrier grouping by OuvrierId
    
    --Dependencies--
    -_cheminsPrefereService: CheminsPrefereService
  }
  
  package "DTOs Export" {
    class PlanningExportDto {
      +NomProjet: string
      +TypeSortie: string
      +DateDebut: DateTime
      +DateFin: DateTime
      +CoutTotal: decimal
      +Ouvriers: List<PlanningOuvrierDto>
      +Metiers: List<SyntheseMetierDto>
    }
    
    class PlanningOuvrierDto {
      +Nom: string
      +Prenom: string
      +Metier: string
      +TauxOccupation: double
      +TauxFragmentation: double
      +HeuresTravaillees: double
      +Creneaux: List<CreneauTravailDto>
    }
    
    class CreneauTravailDto {
      +Date: DateTime
      +TacheNom: string
      +BlocId: string
      +DureeHeures: int
      +EstJourVide: bool
    }
  }
}

' ================================================
' === üÜï COUCHE INFRASTRUCTURE (v0.4.1) ===
' ================================================
package "üîß Services Infrastructure" as INFRA {
  
  class CheminsPrefereService {
    == Gestion Chemins UX ==
    +ObtenirDernierDossier()
    +SauvegarderDernierDossier()
    +ObtenirFichiersRecents()
    
    == Smart Defaults ==
    -ObtenirSmartDefault()
    -AjouterFichierRecent()
    
    == Types Op√©rations ==
    ImportCsv, ImportExcel
    ExportGantt, ExportExcel
    ProjetSauvegarde, ProjetChargement
    
    --Dependencies--
    Properties.Settings (Windows)
  }
  
  package "Configuration Windows" {
    class "Properties.Settings" as Settings {
      +DernierDossierProjets: string
      +DernierDossierImportCsv: string
      +DernierDossierImportExcel: string
      +DernierDossierExports: string
      +FichiersProjetRecents: StringCollection
    }
  }
}

' ================================================
' === COUCHE DATA ===
' ================================================
package "üóÑÔ∏è Acc√®s aux Donn√©es" as DATA {
  
  package "Entit√©s M√©tier" {
    class ProjetData {
      +Taches: List<Tache>
      +Lots: List<Lot>
      +Blocs: List<Bloc>
      +Metiers: List<Metier>
      +Ouvriers: List<Ouvrier>
    }
    
    class Tache {
      +TacheId: string
      +IdImporte: string
      +TacheNom: string
      +HeuresHommeEstimees: int
      +MetierId: string
      +Dependencies: string
      +ExclusionsDependances: string
      +Type: TypeActivite
      +EstJalon: bool (computed)
      +LotId: string
      +BlocId: string
    }
    
    enum TypeActivite {
      Tache
      JalonUtilisateur
      JalonDeSynchronisation
      JalonTechnique
    }
    
    class Lot {
      +LotId: string
      +Nom: string
      +Priorite: int
      +CheminFichierPlan: string
      +Phases: ChantierPhase
    }
    
    class Bloc {
      +BlocId: string
      +Nom: string
      +CapaciteMaxOuvriers: int
    }
    
    class Metier {
      +MetierId: string
      +Nom: string
      +PrerequisMetierIds: string
      +CouleurHex: string
      +Pictogram: string
      +Phases: ChantierPhase
    }
    
    class Ouvrier {
      +OuvrierId: string
      +Nom: string
      +Prenom: string
      +CoutJournalier: int
      +MetierId: string
      +NiveauExpertise: NiveauExpertise
      +PerformancePct: int?
      
      Note: Same OuvrierId can appear
      multiple times (multi-m√©tiers)
    }
    
    enum ChantierPhase {
      None
      GrosOeuvre
      SecondOeuvre
      Finition
      GarantieDecennale
    }
    
    enum NiveauExpertise {
      Debutant
      Confirme
      Expert
    }
  }
  
  package "Services Data" {
    class CsvDataService {
      +ImportCsv()
      +ExportCsv()
      +ValidateCsvStructure()
    }
    
    class ExcelReader {
      +ImportExcel()
      +ImportSapOuvriers()
      +ImportFieldwireTaches()
    }
    
    class GanttExportService {
      +ExporterVersGanttProjectXml()
      +GenererXmlGanttProjectConsolide()
    }
    
    class IdGeneratorService {
      +GenererProchainId()
      +ValiderFormatId()
      
      --Dependencies--
      -_projetService: ProjetService
    }
    
    class ImportService {
      +ImporterTachesDepuisCsv()
      +ValiderStructureFichier()
      
      --Dependencies--
      -_projetService: ProjetService
    }
  }
  
  package "Configuration & Helpers" {
    class ImportMappingConfiguration
    class DependanceBuilder {
      --Dependencies--
      -_projetService: ProjetService
    }
    class ConfigurationBuilder
    class ConfigurationUI {
      +JoursOuvres: List<DayOfWeek>
      +DureeJournaliereStandardHeures: int
      +TypeDeSortie: string
      +HeuresTravailEffectifParJour: int
      
      Note: R√©utilis√© par Export Excel
      pour calculs KPI coh√©rents
    }
  }
  
  package "Processing" {
    class DataTransformer {
      --Dependencies--
      -_projetService: ProjetService
    }
    class PreparationSolveurService
    class ResultatConsolidationService
  }
}

' ================================================
' === EXTERNE ===
' ================================================
package "üåç Syst√®mes Externes" as EXTERNAL {
  class PlanAthenaCoreFacade {
    +ProcessChantier()
    +OptimiserPlanification()
  }
  
  class "Biblioth√®ques v0.4.1" as LIBS {
    +QuikGraph (Graphes)
    +CsvHelper (CSV)
    +Microsoft.Msagl (Diagrammes)
    +EPPlusFree 4.5.3.8 (Excel)
    +System.Text.Json (JSON)
    +Google.OrTools (Solveur)
  }
}

' ================================================
' === RELATIONS PRINCIPALES ===
' ================================================

' UI vers Business
UI -down-> BUSINESS : "Utilise"

' üÜï UI vers Export
UI -down-> EXPORT : "Export Planning"

' üÜï UI vers Infrastructure  
UI -down-> INFRA : "Chemins Pr√©f√©r√©s"

' Business vers Data
BUSINESS -down-> DATA : "Persiste"

' üÜï Export vers Business
EXPORT -down-> BUSINESS : "Lit donn√©es"

' üÜï Export vers Infrastructure
EXPORT -right-> INFRA : "Gestion chemins"

' Data vers External
DATA -down-> EXTERNAL : "Int√®gre"

' Relations d√©taill√©es principales
ProjetService -down-> ProjetData
TacheService -down-> Tache
OuvrierService -down-> Ouvrier
PlanificationService -down-> PlanAthenaCoreFacade

MainForm -down-> ProjetService
MainForm -down-> PlanningExcelExportService : "üÜï Export Excel"
MainForm -down-> CheminsPrefereService : "üÜï Chemins"

TacheForm -down-> TacheService
LotForm -down-> ProjetService : "Utilise pour lots"
OuvrierForm -down-> OuvrierService
PlanificationService -right-> TacheService : "Charge donn√©es"
ImportOrchestrationService -down-> CsvDataService

' üÜï Relations Export
PlanningExcelExportService -down-> PlanningExportDto
PlanningExcelExportService -down-> ConfigurationUI : "R√©utilise pour KPI"

' üÜï Relations Infrastructure
CheminsPrefereService -down-> Settings

' Relations Factory (√©viter cycles)
TacheService ..> ProjetService : "Func<ProjetService>\n(pour lots)"
BlocService ..> TacheService : "Func<TacheService>\n(√©viter cycle)"

' Nouvelles relations post-fusion
ImportService -up-> ProjetService : "lots"
DependanceBuilder -up-> ProjetService : "lots"
DataTransformer -up-> ProjetService : "lots"
IdGeneratorService -up-> ProjetService : "lots"

' ================================================
' === NOTES M√âTIER v0.4.1 ===
' ================================================

note top of EXPORT
<b>üÜï NOUVEAUT√â v0.4.1 : Export Planning Excel</b>
‚úÖ Multi-onglets : Synth√®se + 1 par ouvrier
‚úÖ KPIs avanc√©s : Occupation + Fragmentation  
‚úÖ Support multi-t√¢ches par jour
‚úÖ Templates int√©gr√©s avec formatage
‚úÖ EPPlus 4.5.3.8 (totalement libre)
end note

note top of INFRA
<b>üÜï NOUVEAUT√â v0.4.1 : Chemins Pr√©f√©r√©s</b>
‚úÖ UX am√©lior√©e (-80% clics navigation)
‚úÖ Smart defaults (MyDocuments/PlanAthena)
‚úÖ Persistance Windows (Properties.Settings)
‚úÖ Obligatoire pour tous futurs file dialogs
‚úÖ Fichiers r√©cents (bonus)
end note

note right of ProjetService
<b>Service Unifi√© Projet + Lots + M√©tiers</b>
G√®re maintenant :
‚Ä¢ M√©tiers (ex-MetierService v0.3.8)
‚Ä¢ Lots (ex-LotService v0.3.9)  
‚Ä¢ Projets (fonctions originales)
‚Ä¢ Sauvegarde/chargement complet
üÜï Source donn√©es pour Export Excel
end note

note right of TacheService
<b>Factory pour √©viter cycle</b>
Utilise Func<ProjetService> pour
acc√©der aux lots sans cr√©er de
d√©pendance circulaire directe.
_projetServiceFactory().ObtenirLotParId()
end note

note left of ImportService
<b>Services simplifi√©s</b>
Plus besoin d'injecter s√©par√©ment
ProjetService ET LotService.
Un seul ProjetService suffit.
end note

note right of ConfigurationUI
<b>üÜï R√©utilisation Export Excel</b>
ConfigurationUI r√©utilis√©e pour :
‚Ä¢ Source v√©rit√© : numDureeStandard
‚Ä¢ Jours ouvr√©s : chkListJoursOuvres  
‚Ä¢ Type sortie : cmbTypeDeSortie
‚Üí Coh√©rence calculs KPI garantie
end note

note bottom of Ouvrier
<b>üö® Workaround Multi-M√©tiers</b>
M√™me OuvrierId peut appara√Ætre plusieurs fois
avec diff√©rents MetierId pour g√©rer la polyvalence.
Export Excel regroupe par OuvrierId.
üîÑ TODO v0.5 : Refonte syst√®me m√©tiers
end note

note bottom of LIBS
<b>üÜï Ajouts v0.4.1 :</b>
‚Ä¢ EPPlusFree 4.5.3.8 : Export Excel
‚Ä¢ Properties.Settings : Persistance Windows
‚Ä¢ Calculs KPI avanc√©s int√©gr√©s
end note

@enduml