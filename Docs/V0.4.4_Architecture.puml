@startuml
'---------------------------------
' Configuration
'---------------------------------
!theme toy
skinparam linetype ortho
skinparam packageStyle rectangle
skinparam backgroundColor White
skinparam componentStyle uml2
skinparam shadowing false

' Couleurs par couche
skinparam package {
  BackgroundColor<<UI>> LightBlue
  BorderColor<<UI>> DarkBlue
  BackgroundColor<<Business>> LightGreen
  BorderColor<<Business>> DarkGreen
  BackgroundColor<<Data>> LightYellow
  BorderColor<<Data>> DarkOrange
  BackgroundColor<<External>> LightGray
  BorderColor<<External>> Black
}

title Diagramme d'Architecture de l'Application (Final)\n<size:12><i>Architecture en couches avec flux de d√©pendances</i></size>

'---------------------------------
' D√©finition des Couches et Composants
'---------------------------------
package "üñ•Ô∏è **Interface Utilisateur**" <<UI>> as UI {
  component [MainForm] as MF
  component [TacheForm] as TF
  component [OuvrierForm] as OF
  component [MetierForm] as MetF
  component [PrerequisMetierForm] as PMF
}

package "‚öôÔ∏è **Services M√©tier**" <<Business>> as Business {
  component "<b>ProjetService</b>\n<size:10><i>G√®re la structure du projet</i>" as PS
  component "<b>RessourceService</b>\n<size:10><i>G√®re les ressources</i>" as RS
  component "<b>PlanificationService</b>\n<size:10><i>Orchestre la planification</i>\n--------\n Use ConfigurationGuilder\n Use DataTransformer\n Use PreparationSolveur\n Use ConsolidationResultat" as PlanS
  ' ImportService est un processus m√©tier, sa place est ici.
  component "<b>ImportService</b>\n<size:10><i>Orchestre l'import (CSV)</i>" as IS
  
  package "Logique de Traitement" as Processing {
    component "<b>DependanceBuilder</b>\n<size:10><i>Logique des r√®gles de pr√©c√©dence</i>" as DB
    component [IdGenerator] as IG
  }
}

package "üîß **Infrastructure & Acc√®s Donn√©es**" <<Data>> as DataLayer {
  component "<b>ProjetRepository</b>\n<size:10><i>Persistance du projet (JSON)</i>" as PR
  component [ExportServices] as ES
  component [CsvDataService] as CSV
  component [PlanningExcelExportService] as XLS
}

package "üåç **Moteur Externe**" <<External>> as External {
  component "<b>PlanAthenaCore</b>\n<size:10><i>Moteur de calcul (DLL externe)</i>" as PAC
}

'---------------------------------
' Relations & Structure
'---------------------------------
UI -[hidden]d-> Business
Business -[hidden]d-> DataLayer

' Flux principal entre couches
UI .down.> Business : "Appels m√©tier"
Business .down.> DataLayer : "Acc√®s donn√©es"
'Business -l-> External : "Calcul externe"

' Note sur MainForm
note right of MF
  <b>Composant H√©rit√© (Legacy)</b>
  Ce formulaire sera supprim√©
  dans la refonte IHM v0.5.0.
end note

' Relations IHM -> Services M√©tier
TF ..> PS
TF ..> RS
TF ..> DB
OF ..> RS
OF ..> IS
MetF ..> RS
MetF ..> DB
PMF ..> PS
PMF ..> RS
PMF ..> DB

' Relations Couche M√©tier
PlanS .r.> PAC
DB ..> PS
DB ..> RS
IS --> PS
IS --> RS
IS ..> IG 
PS ..> IG
RS ..> IG

' Relations M√©tier -> Couche Donn√©es
IS .d.> CSV

'---------------------------------
' L√©gende
'---------------------------------
legend right
  <b>L√©gende</b>
  ..> Utilisation / Appel
  --> D√©pendance forte
  
  <b>Flux Principal</b>
  IHM ‚Üí M√©tier ‚Üí Donn√©es
  M√©tier ‚Üí Moteur Externe
end legend

@enduml